<!DOCTYPE html>
   <html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom File Mail Merge Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        /* Page background: subtle stripes */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fb;
            background-image: linear-gradient(135deg, rgba(255,255,255,0.6) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.6) 75%, transparent 75%, transparent);
            background-size: 18px 18px;
            color: #1f2933;
        }

        .app-shell {
            max-width: 1000px;
            margin: 32px auto;
            padding: 0 16px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .app-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 0.03em;
            margin-bottom: 4px;
            color: #102a43;
        }

        .app-subtitle {
            font-size: 0.95rem;
            color: #627d98;
        }

        /* Step cards */
        .step-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 35px 20px 18px 20px;
            margin-bottom: 16px;
            box-shadow:
                0 1px 2px rgba(15, 23, 42, 0.06),
                0 8px 20px rgba(15, 23, 42, 0.03);
            border: 1px solid #d9e2ec;
            position: relative;
            overflow: hidden;
        }

        .step-card::before {
            content: attr(data-step);
            position: absolute;
            top: 0;
            left: 0;
            padding: 6px 14px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #ffffff;
            background: linear-gradient(120deg, #2563eb, #1d4ed8);
            border-bottom-right-radius: 10px;
        }

        .step-card--accent-1::before {
            background: linear-gradient(120deg, #0ea5e9, #0284c7);
        }

        .step-card--accent-2::before {
            background: linear-gradient(120deg, #22c55e, #16a34a);
        }

        .step-card--accent-3::before {
            background: linear-gradient(120deg, #f59e0b, #d97706);
        }

        .step-card--accent-4::before {
            background: linear-gradient(120deg, #6366f1, #4f46e5);
        }

        .step-heading {
            margin: 4px 0 10px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #102a43;
        }

        .step-body {
            margin-top: 4px;
        }

        label {
            display: block;
            margin-top: 8px;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.92rem;
            color: #243b53;
        }

        input[type="file"],
        select {
            width: 100%;
            padding: 8px 10px;
            font-size: 0.95rem;
            border-radius: 6px;
            border: 1px solid #cbd2d9;
            box-sizing: border-box;
            background-color: #ffffff;
            color: #102a43;
            transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
        }

        input[type="file"]:focus,
        select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        select:disabled,
        input[disabled] {
            background-color: #f4f7fb;
            color: #9fb3c8;
            cursor: not-allowed;
        }

        /* Primary button */
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            margin-top: 8px;
            background: linear-gradient(120deg, #2563eb, #1d4ed8);
            color: #ffffff;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 0.98rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            box-shadow: 0 10px 18px rgba(37, 99, 235, 0.25);
            transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease, background 0.08s ease;
            white-space: nowrap;
        }

        .button:hover:not(:disabled) {
            filter: brightness(1.03);
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.28);
        }

        .button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 6px 14px rgba(37, 99, 235, 0.25);
        }

        .button:disabled {
            background: #cbd2d9;
            color: #7b8794;
            box-shadow: none;
            cursor: not-allowed;
        }

        .button--secondary {
            background: #ffffff;
            color: #2563eb;
            border: 1px solid #cbd2d9;
            box-shadow: none;
        }

        .button--secondary:hover:not(:disabled) {
            background: #eff6ff;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
        }

        /* Status messages with positive/negative reinforcement */
        .status {
            margin-top: 6px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background-color: #f5f7fb;
            color: #52606d;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9fb3c8;
            flex-shrink: 0;
        }

        .status--success {
            background-color: #ecfdf5;
            color: #166534;
        }

        .status--success .status-dot {
            background-color: #16a34a;
        }

        .status--error {
            background-color: #fef2f2;
            color: #b91c1c;
        }

        .status--error .status-dot {
            background-color: #ef4444;
        }

        .status--info {
            background-color: #eff6ff;
            color: #1d4ed8;
        }

        .status--info .status-dot {
            background-color: #2563eb;
        }

        /* Temporary green flash on success */
        .flash-success {
            animation: flashSuccess 0.8s ease-out;
        }

        @keyframes flashSuccess {
            0% { background-color: #dcfce7; }
            60% { background-color: #ecfdf5; }
            100% { background-color: transparent; }
        }

        .note {
            font-size: 0.85rem;
            color: #627d98;
            margin-top: 4px;
        }

        .preview-box {
            background: #f8fafc;
            border: 1px solid #d9e2ec;
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 6px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            white-space: pre-wrap;
            font-size: 0.85rem;
            color: #334e68;
        }

        ul {
            margin: 4px 0 0 18px;
            padding: 0;
            font-size: 0.9rem;
            color: #52606d;
        }

        li {
            margin-bottom: 3px;
        }

        .footer-note {
            margin-top: 18px;
            font-size: 0.8rem;
            color: #829ab1;
            text-align: center;
        }

        .inline-code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background: #e3edf7;
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* Visual Help Styles */
        .visual-help-container {
            display: grid;
            gap: 20px;
            margin-top: 15px;
        }
        
        .visual-block {
            flex: 1;
        }
        
        .visual-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #627d98;
            margin-bottom: 6px;
            font-weight: 700;
        }

        /* Mock Excel Table Styles */
        .mock-excel-wrapper {
            overflow-x: auto;
            border: 1px solid #d9e2ec;
            border-radius: 6px;
            background: #fff;
        }
        .mock-excel {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            font-size: 13px;
        }
        .mock-excel th, .mock-excel td {
            border: 1px solid #e2e8f0;
            padding: 4px 8px;
            text-align: left;
        }
        .mock-excel th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: normal;
            text-align: center;
        }
        .mock-excel .excel-header-row td {
            font-weight: bold;
            background-color: #ffffff;
            border-bottom: 2px solid #22c55e; /* Excel green hint */
        }
        .mock-excel .excel-row-num {
            background-color: #f1f5f9;
            color: #64748b;
            text-align: center;
            width: 30px;
        }

        /* Mock Word Doc Styles */
        .mock-word {
            background: #fff;
            border: 1px solid #d9e2ec;
            box-shadow: 2px 3px 8px rgba(0,0,0,0.05);
            padding: 20px;
            border-radius: 2px;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            line-height: 1.4;
            position: relative;
        }
        .mock-word-h1 {
            font-size: 18px;
            font-weight: bold;
            color: #2f5496; /* Word blue */
            margin-bottom: 12px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 4px;
        }
        .highlight-placeholder {
            background-color: #fef3c7;
            color: #b45309;
            font-family: monospace;
            padding: 0 2px;
            border-radius: 3px;
            font-weight: bold;
            border: 1px dashed #d97706;
        }

        @media (min-width: 768px) {
            .step-layout-2col {
                display: grid;
                grid-template-columns: 1.1fr 1fr;
                gap: 16px;
                align-items: flex-start;
            }
            .visual-help-container {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="app-title">Custom filename Mail Merge Generator</div>
        <div class="app-subtitle">Create custom Word documents from Excel data with a custom filename.</div>
    </header>
     <section class="step-card" data-step="Help">
        <h2 class="step-heading">Visual Guide</h2>
        <div class="step-body">
            <p style="margin-bottom:15px; color:#52606d; font-size:0.95rem;">
                Ensure your Excel headers match the text inside the curly brackets <span class="inline-code">{{ }}</span> in your Word template.
            </p>

            <div class="visual-help-container">
                <div class="visual-block">
                    <div class="visual-label">1. Excel File Example</div>
                    <div class="mock-excel-wrapper">
                        <table class="mock-excel">
                            <thead>
                                <tr>
                                    <th class="excel-row-num"></th>
                                    <th>A</th>
                                    <th>B</th>
                                    <th>C</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="excel-header-row">
                                    <td class="excel-row-num">1</td>
                                    <td>Name</td>
                                    <td>ID</td>
                                    <td>Comment</td>
                                </tr>
                                <tr>
                                    <td class="excel-row-num">2</td>
                                    <td>John Doe</td>
                                    <td>10045</td>
                                    <td>A great effort. But consider...</td>
                                </tr>
                                <tr>
                                    <td class="excel-row-num">3</td>
                                    <td>Jane Smith</td>
                                    <td>10046</td>
                                    <td>This falls short of the requirments...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="note">Row 1 must contain headers.</p>
                </div>

                <div class="visual-block">
                    <div class="visual-label">2. Word Document Example</div>
                    <div class="mock-word">
                        <div class="mock-word-h1">Assessment 2 Feedback</div>
                        <p>
                            <strong>Student Name:</strong> <strong>{{Name}}</strong>
                        </p>
                        <p>
                            <strong>Student ID:</strong> <strong>{{ID}}</strong>
                        </p>
                        <p>
                            <strong>Comment</strong>,<br><br>
                            <strong>{{Comment}}</strong>.
                        </p>
                    </div>
                    <p class="note">Placeholders match Excel headers exactly.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="step-card step-card--accent-1" data-step="Step 1">
        <h2 class="step-heading">Upload Excel file</h2>
        <div class="step-body">
            <label for="excelFile">Excel file (.xlsx)</label>
            <input type="file" id="excelFile" accept=".xlsx" />
            <div id="excelStatus" class="status">
                <span class="status-dot"></span>
                <span>Waiting for Excel file.</span>
            </div>
        </div>
    </section>

    <section class="step-card step-card--accent-2" data-step="Step 2">
        <h2 class="step-heading">Upload Word template</h2>
        <div class="step-body">
            <label for="wordTemplate">Word template (.docx)</label>
            <input type="file" id="wordTemplate" accept=".docx" />
            <div id="wordStatus" class="status">
                <span class="status-dot"></span>
                <span>Waiting for template.</span>
            </div>
        </div>
    </section>

    <section class="step-card step-card--accent-3" data-step="Step 3">
        <h2 class="step-heading">Configure mail merge</h2>
        <div class="step-layout-2col step-body">
            <div>
                <label for="sheetSelect">Excel sheet</label>
                <select id="sheetSelect" disabled></select>

                <label for="filenameColumnSelect">Filename column</label>
                <select id="filenameColumnSelect" disabled></select>
                <p class="note">
                    Each generated document is named using values from this column (for example <span class="inline-code">Name</span> or <span class="inline-code">ID</span>).
                </p>
            </div>
            <div>
                <label>Preview of first row</label>
                <div id="rowPreview" class="preview-box">No data loaded yet.</div>
            </div>
        </div>
    </section>

    <section class="step-card step-card--accent-4" data-step="Step 4">
        <h2 class="step-heading">Generate documents</h2>
        <div class="step-body">
            <button id="generateBtn" class="button" disabled>Generate and download all documents</button>
            <div id="generateStatus" class="status status--info" style="margin-left:8px;">
                <span class="status-dot"></span>
                <span>Ready when all steps above are complete.</span>
            </div>
        </div>
    </section>

   

    <div class="footer-note">
        All processing happens in your browser. No files are uploaded to a server.
    </div>
</div>

<script>
    let workbook = null;
    let excelDataBySheet = {};
    let wordTemplateArrayBuffer = null;
    // Cached template base files to avoid reloading/parsing the .docx for every row
    let templateBaseFiles = null;

    const excelFileInput = document.getElementById('excelFile');
    const wordTemplateInput = document.getElementById('wordTemplate');
    const sheetSelect = document.getElementById('sheetSelect');
    const filenameColumnSelect = document.getElementById('filenameColumnSelect');
    const rowPreview = document.getElementById('rowPreview');
    const generateBtn = document.getElementById('generateBtn');

    const excelStatus = document.getElementById('excelStatus');
    const wordStatus = document.getElementById('wordStatus');
    const generateStatus = document.getElementById('generateStatus');

    function setStatus(el, type, message, flash = false) {
        el.className = 'status';
        if (type === 'success') el.classList.add('status--success');
        if (type === 'error') el.classList.add('status--error');
        if (type === 'info') el.classList.add('status--info');

        const dot = el.querySelector('.status-dot');
        const textSpan = el.querySelector('span:last-child');
        if (textSpan) textSpan.textContent = message;

        if (flash) {
            el.classList.add('flash-success');
            setTimeout(() => el.classList.remove('flash-success'), 800);
        }
    }

    function resetExcelState() {
        workbook = null;
        excelDataBySheet = {};
        sheetSelect.innerHTML = '';
        filenameColumnSelect.innerHTML = '';
        sheetSelect.disabled = true;
        filenameColumnSelect.disabled = true;
        rowPreview.textContent = 'No data loaded yet.';
    }

    function resetWordState() {
        wordTemplateArrayBuffer = null;
        templateBaseFiles = null;
    }

    function updateGenerateButtonState() {
        const hasExcel = workbook !== null;
        const hasTemplate = templateBaseFiles !== null; // require prepared template cache
        const sheetSelected = sheetSelect.value !== '';
        const filenameColSelected = filenameColumnSelect.value !== '';
        const enabled = hasExcel && hasTemplate && sheetSelected && filenameColSelected;
        generateBtn.disabled = !enabled;

        if (enabled) {
            setStatus(generateStatus, 'info', 'Ready to generate documents.');
        } else {
            setStatus(generateStatus, 'info', 'Ready when all steps above are complete.');
        }
    }

    function safeText(text) {
        if (text === null || text === undefined) return '';
        return String(text);
    }

    excelFileInput.addEventListener('change', function () {
        resetExcelState();
        setStatus(excelStatus, 'info', 'Checking file…');
        setStatus(generateStatus, 'info', 'Ready when all steps above are complete.');

        const file = excelFileInput.files[0];
        if (!file) {
            setStatus(excelStatus, 'error', 'No file selected.');
            updateGenerateButtonState();
            return;
        }

        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            setStatus(excelStatus, 'error', 'Please select a .xlsx Excel file.');
            excelFileInput.value = '';
            updateGenerateButtonState();
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, { type: 'array' });

                excelDataBySheet = {};
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    excelDataBySheet[sheetName] = json;
                });

                sheetSelect.innerHTML = '';
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '-- Select sheet --';
                sheetSelect.appendChild(placeholderOption);

                workbook.SheetNames.forEach(sheetName => {
                    const opt = document.createElement('option');
                    opt.value = sheetName;
                    opt.textContent = sheetName;
                    sheetSelect.appendChild(opt);
                });

                sheetSelect.disabled = false;
                setStatus(excelStatus, 'success', 'Excel file loaded. Select a sheet.', true);
            } catch (err) {
                console.error(err);
                setStatus(excelStatus, 'error', 'Error reading Excel file: ' + err.message);
                resetExcelState();
            }
            updateGenerateButtonState();
        };

        reader.onerror = function () {
            setStatus(excelStatus, 'error', 'Error reading Excel file.');
            resetExcelState();
            updateGenerateButtonState();
        };

        reader.readAsArrayBuffer(file);
    });

    sheetSelect.addEventListener('change', function () {
        const sheetName = sheetSelect.value;
        filenameColumnSelect.innerHTML = '';
        filenameColumnSelect.disabled = true;
        rowPreview.textContent = 'No data loaded yet.';

        if (!sheetName || !excelDataBySheet[sheetName]) {
            updateGenerateButtonState();
            return;
        }

        const rows = excelDataBySheet[sheetName];
        if (!rows || rows.length === 0) {
            rowPreview.textContent = 'Selected sheet has no data.';
            updateGenerateButtonState();
            return;
        }

        const firstRow = rows[0];
        const columns = Object.keys(firstRow);

        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = '-- Select filename column --';
        filenameColumnSelect.appendChild(placeholderOption);

        columns.forEach(col => {
            const opt = document.createElement('option');
            opt.value = col;
            opt.textContent = col;
            filenameColumnSelect.appendChild(opt);
        });

        filenameColumnSelect.disabled = false;

        let previewText = '';
        columns.forEach(col => {
            previewText += col + ': ' + safeText(firstRow[col]) + '\n';
        });
        rowPreview.textContent = previewText;

        updateGenerateButtonState();
    });

    filenameColumnSelect.addEventListener('change', function () {
        updateGenerateButtonState();
    });

    // Prepare template: load .docx once and cache all files.
    async function prepareTemplate(templateArrayBuffer) {
        const zip = await JSZip.loadAsync(templateArrayBuffer);
        const files = {};
        const promises = [];

        zip.forEach((relativePath, file) => {
            if (file.dir) {
                files[relativePath] = { dir: true };
                return;
            }
            // Read as uint8array for binary stability; decode document.xml to text for replacements.
            const p = file.async('uint8array').then(content => {
                if (relativePath === 'word/document.xml') {
                    const text = new TextDecoder('utf-8').decode(content);
                    files[relativePath] = { content: text, isText: true };
                } else {
                    files[relativePath] = { content: content, isText: false };
                }
            });
            promises.push(p);
        });

        await Promise.all(promises);
        templateBaseFiles = files;
    }

    // Build a new .docx from cached base files, replacing placeholders in word/document.xml
    function createDocumentBlobFromTemplate(rowData) {
        const zip = new JSZip();

        Object.keys(templateBaseFiles).forEach(path => {
            const entry = templateBaseFiles[path];
            if (!entry) return;
            if (entry.dir) {
                // ensure folder exists (JSZip creates folders automatically when files added)
                return;
            }

            if (path === 'word/document.xml' && entry.isText) {
                let xml = entry.content;
                Object.keys(rowData).forEach(key => {
                    const placeholder = '{{' + key + '}}';
                    const value = safeText(rowData[key]);
                    const escapedPlaceholder = placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    xml = xml.replace(new RegExp(escapedPlaceholder, 'g'), value);
                });
                zip.file(path, xml);
            } else {
                zip.file(path, entry.content);
            }
        });

        return zip.generateAsync({ type: 'blob' });
    }

    wordTemplateInput.addEventListener('change', function () {
        resetWordState();
        setStatus(wordStatus, 'info', 'Checking file…');
        setStatus(generateStatus, 'info', 'Ready when all steps above are complete.');

        const file = wordTemplateInput.files[0];
        if (!file) {
            setStatus(wordStatus, 'error', 'No file selected.');
            updateGenerateButtonState();
            return;
        }

        if (!file.name.toLowerCase().endsWith('.docx')) {
            setStatus(wordStatus, 'error', 'Please select a .docx Word file.');
            wordTemplateInput.value = '';
            updateGenerateButtonState();
            return;
        }

        const reader = new FileReader();
        reader.onload = async function (e) {
            try {
                wordTemplateArrayBuffer = e.target.result;
                await prepareTemplate(wordTemplateArrayBuffer);
                setStatus(wordStatus, 'success', 'Word template loaded and cached.', true);
            } catch (err) {
                console.error(err);
                setStatus(wordStatus, 'error', 'Error preparing Word template: ' + err.message);
                resetWordState();
            }
            updateGenerateButtonState();
        };

        reader.onerror = function () {
            setStatus(wordStatus, 'error', 'Error reading Word template.');
            resetWordState();
            updateGenerateButtonState();
        };

        reader.readAsArrayBuffer(file);
    });

    generateBtn.addEventListener('click', async function () {
        setStatus(generateStatus, 'info', 'Generating documents, please wait…');

        const sheetName = sheetSelect.value;
        const filenameColumn = filenameColumnSelect.value;

        if (!sheetName || !excelDataBySheet[sheetName]) {
            setStatus(generateStatus, 'error', 'Please select a valid sheet.');
            return;
        }

        if (!filenameColumn) {
            setStatus(generateStatus, 'error', 'Please select a filename column.');
            return;
        }

        const rows = excelDataBySheet[sheetName];
        if (!rows || rows.length === 0) {
            setStatus(generateStatus, 'error', 'Selected sheet has no data.');
            return;
        }

        if (!templateBaseFiles) {
            setStatus(generateStatus, 'error', 'Please upload a Word template.');
            return;
        }

        generateBtn.disabled = true;

        try {
            const zip = new JSZip();
            let generatedCount = 0;

            for (let i = 0; i < rows.length; i++) {
                const rowData = rows[i];
                const rawFilename = safeText(rowData[filenameColumn]) || ('Document_' + (i + 1));
                const safeFilename = rawFilename.replace(/[\\/:*?"<>|]+/g, '_').trim() || ('Document_' + (i + 1));
                // Build document from cached base files
                const docBlob = await createDocumentBlobFromTemplate(rowData);
                zip.file(safeFilename + '.docx', docBlob);
                generatedCount++;
            }

            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const zipFileName = 'mail_merge_' + (sheetName || 'documents') + '.zip';

            saveAs(zipBlob, zipFileName);

            setStatus(generateStatus, 'success', 'Generated ' + generatedCount + ' documents. Download starting…', true);
        } catch (err) {
            console.error(err);
            setStatus(generateStatus, 'error', 'Error generating documents: ' + err.message);
        } finally {
            updateGenerateButtonState();
        }
    });
</script>
</body>
</html>